<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test API Data Fetch with CORS Bypass</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }
    th {
      background-color: #ddd;
    }
  </style>
</head>
<body>
  <h1>Test API Data Fetch with CORS Bypass</h1>
  <div>
    <label>Client ID:</label>
    <input type="text" id="client_id">
  </div>
  <div>
    <label>Client Secret:</label>
    <input type="password" id="client_secret">
  </div>
  <button id="fetchDataBtn">Fetch Data</button>
  
  <div id="output" style="margin-top:20px;"></div>
  
  <!-- Include the TACO Toolkit SDK; update the path as needed -->
  <script src="path/to/taco-toolkit.js"></script>
  <script>
    document.getElementById("fetchDataBtn").addEventListener("click", function() {
      // Clear previous output
      document.getElementById("output").innerHTML = "Loading data...";
      
      var clientId = document.getElementById("client_id").value.trim();
      var clientSecret = document.getElementById("client_secret").value.trim();
      
      if (!clientId || !clientSecret) {
        document.getElementById("output").innerText = "Please enter both Client ID and Client Secret.";
        return;
      }
      
      // Step 1: Obtain OAuth token using taco.get() with CORS bypass
      taco.get("https://auth.sensourceinc.com/oauth/token", {
         method: "POST",
         contentType: "application/json",
         data: JSON.stringify({
             "grant_type": "client_credentials",
             "client_id": clientId,
             "client_secret": clientSecret
         }),
         bypassCorsPolicy: true
      })
      .then(function(authResponse) {
          var accessToken = authResponse.access_token;
          // Define fixed one-hour period parameters
          var params = {
              "relativeDate": "custom",
              "startDate": "2025-02-01T08:00:00Z", // UTC for 2/1/2025 midnight PT
              "endDate": "2025-02-01T09:00:00Z",   // one hour later
              "dateGroupings": "hour",
              "entityType": "zone"
          };
          // Step 2: Fetch traffic data using the access token
          return taco.get("https://vea.sensourceinc.com/api/data/traffic", {
             method: "GET",
             headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + accessToken
             },
             data: params,
             bypassCorsPolicy: true
          });
      })
      .then(function(dataResponse) {
         // Take the first five rows of data
         var results = dataResponse.results || [];
         var firstFive = results.slice(0, 5);
         
         // Build an HTML table to display the data
         var html = "<table><thead><tr>" +
                    "<th>Date Time</th><th>Entrance</th><th>Entries</th><th>Exits</th>" +
                    "</tr></thead><tbody>";
         firstFive.forEach(function(item) {
             var dt = new Date(item.recordDate_hour_1).toLocaleString();
             var entrance = item.name || "Unknown";
             var entries = item.sumins || 0;
             var exits = item.sumouts || 0;
             html += "<tr><td>" + dt + "</td><td>" + entrance + "</td><td>" + entries + "</td><td>" + exits + "</td></tr>";
         });
         html += "</tbody></table>";
         document.getElementById("output").innerHTML = html;
      })
      .catch(function(error) {
         document.getElementById("output").innerText = "Error: " + error;
      });
    });
  </script>
</body>
</html>
