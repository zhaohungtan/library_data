<!DOCTYPE html>
<html>
<head>
    <title>VEA API Data Retriever</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        input, button { 
            margin: 10px 0; 
            padding: 5px; 
            width: 100%; 
        }
        #results, #tokenResults { 
            margin-top: 20px; 
            border: 1px solid #ddd; 
            padding: 10px; 
        }
        #errorMsg { 
            color: red; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
    </style>
</head>
<body>
    <h1>VEA API Data Retriever</h1>
    
    <label for="client_id">Client ID:</label>
    <input type="text" id="client_id" placeholder="Enter your Client ID">
    
    <label for="client_secret">Client Secret:</label>
    <input type="password" id="client_secret" placeholder="Enter your Client Secret">
    
    <label for="start_date">Start Date (YYYY-MM-DD):</label>
    <input type="text" id="start_date" value="2025-02-01">
    
    <label for="end_date">End Date (YYYY-MM-DD):</label>
    <input type="text" id="end_date" value="2025-02-02">
    
    <button id="getToken">Get Access Token</button>
    <button id="fetchTrafficData">Fetch Traffic Data</button>
    
    <div id="errorMsg"></div>
    <div id="tokenResults"></div>
    <div id="results"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
    let globalAccessToken = null;

    // Get Access Token
    document.getElementById('getToken').addEventListener('click', function() {
        // Clear previous results and errors
        document.getElementById('errorMsg').innerText = '';
        document.getElementById('tokenResults').innerHTML = '';

        // Get input values
        const clientId = document.getElementById('client_id').value.trim();
        const clientSecret = document.getElementById('client_secret').value.trim();

        // Basic validation
        if (!clientId || !clientSecret) {
            document.getElementById('errorMsg').innerText = 'Please enter both Client ID and Client Secret';
            return;
        }

        // Make AJAX call to get access token
        $.ajax({
            url: "https://auth.sensourceinc.com/oauth/token",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                "grant_type": "client_credentials",
                "client_id": clientId,
                "client_secret": clientSecret
            }),
            success: function(resp) {
                // Store the access token globally
                globalAccessToken = resp.access_token;

                // Display token details
                let tokenHtml = '<h2>Access Token Details</h2>';
                tokenHtml += `<p>Access Token: ${resp.access_token}</p>`;
                tokenHtml += `<p>Expires In: ${resp.expires_in} seconds</p>`;
                tokenHtml += `<p>Token Type: ${resp.token_type}</p>`;

                document.getElementById('tokenResults').innerHTML = tokenHtml;
            },
            error: function(xhr, status, err) {
                // Display error details
                let errorMessage = 'Error retrieving access token: ';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += xhr.responseJSON.message;
                } else {
                    errorMessage += err || 'Unknown error';
                }

                document.getElementById('errorMsg').innerText = errorMessage;
                console.error('Full error:', xhr);
            }
        });
    });

    // Fetch Traffic Data
    document.getElementById('fetchTrafficData').addEventListener('click', function() {
        // Clear previous results and errors
        document.getElementById('errorMsg').innerText = '';
        document.getElementById('results').innerHTML = '';

        // Check if we have an access token
        if (!globalAccessToken) {
            document.getElementById('errorMsg').innerText = 'Please get an access token first';
            return;
        }

        // Get input values
        const startDate = document.getElementById('start_date').value.trim();
        const endDate = document.getElementById('end_date').value.trim();

        // Convert dates to ISO format
        const startISO = new Date(startDate).toISOString();
        const endISO = new Date(endDate).toISOString();

        // Make AJAX call to fetch traffic data
        $.ajax({
            url: "https://vea.sensourceinc.com/api/data/traffic",
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${globalAccessToken}`
            },
            data: {
                "relativeDate": "custom",
                "startDate": startISO,
                "endDate": endISO,
                "dateGroupings": "hour",
                "entityType": "zone"
            },
            success: function(resp) {
                // Create a table to display results
                let resultsHtml = '<h2>Traffic Data</h2>';
                resultsHtml += `<p>Total Records: ${resp.results ? resp.results.length : 0}</p>`;
                
                if (resp.results && resp.results.length > 0) {
                    resultsHtml += '<table>';
                    resultsHtml += '<tr><th>Zone Name</th><th>Date</th><th>Zone ID</th><th>Entries</th><th>Exits</th></tr>';
                    
                    resp.results.forEach(function(record) {
                        resultsHtml += `<tr>
                            <td>${record.name || 'Unknown'}</td>
                            <td>${record.recordDate_hour_1 || 'N/A'}</td>
                            <td>${record.zoneId || 'N/A'}</td>
                            <td>${record.sumins || 0}</td>
                            <td>${record.sumouts || 0}</td>
                        </tr>`;
                    });
                    
                    resultsHtml += '</table>';
                } else {
                    resultsHtml += '<p>No data found for the selected date range.</p>';
                }

                document.getElementById('results').innerHTML = resultsHtml;
            },
            error: function(xhr, status, err) {
                // Display error details
                let errorMessage = 'Error retrieving traffic data: ';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += xhr.responseJSON.message;
                } else {
                    errorMessage += err || 'Unknown error';
                }

                document.getElementById('errorMsg').innerText = errorMessage;
                console.error('Full error:', xhr);
            }
        });
    });
    </script>
</body>
</html>
