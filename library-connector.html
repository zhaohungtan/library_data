<!DOCTYPE html>
<html>
<head>
    <title>Library Traffic Data Connector</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Import the Tableau WDC library -->
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script>
    
    <!-- Simple styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #errorMsg {
            color: red;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>Library Traffic Data Connector</h1>
    <div id="errorMsg"></div>
    
    <div class="form-group">
        <label for="start_date">Start Date (YYYY-MM-DD):</label>
        <input type="text" id="start_date" value="2025-02-01">
    </div>
    
    <div class="form-group">
        <label for="end_date">End Date (YYYY-MM-DD):</label>
        <input type="text" id="end_date" value="2025-02-02">
    </div>
    
    <button type="button" id="submitButton">Get Data</button>

    <script>
        (function() {
            // Create the connector object
            var myConnector = tableau.makeConnector();
            
            // Define the schema
            myConnector.getSchema = function(schemaCallback) {
                var cols = [{
                    id: "dateTime",
                    alias: "Date-Time",
                    dataType: tableau.dataTypeEnum.datetime
                }, {
                    id: "entrance",
                    alias: "Entrance",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "facility",
                    alias: "Facility",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "entries",
                    alias: "Entries",
                    dataType: tableau.dataTypeEnum.int
                }, {
                    id: "exits",
                    alias: "Exits",
                    dataType: tableau.dataTypeEnum.int
                }];

                var tableSchema = {
                    id: "libraryTraffic",
                    alias: "Library Traffic Data",
                    columns: cols
                };

                schemaCallback([tableSchema]);
            };

            // Define the facility mapping
            var facilityMapping = {
                'AHC Back': 'AHC Library',
                'AHC Front': 'AHC Library',
                'AHC Rear': 'AHC Library',
                'ANTH': 'ANTH Library',
                'Bancroft': 'BANC Library',
                'CHEM': 'CHEM Library',
                'VLSB1': 'BIOS Library',
                'VLSB2': 'BIOS Library',
                'EAL': 'EAL Library',
                'CHEM 2.9': 'CHEM Library',
                'Doe North': 'DOE Library',
                'Doe South': 'DOE Library',
                'HAAS 2nd Floor': 'HAAS Library',
                'HAAS 3rd Floor': 'HAAS Library',
                'MATH': 'MATH Library',
                'Moffit Corridor': 'DOE STACKS',
                'Stacks East': 'DOE STACKS',
                'EAL 2.9': 'EAL Library',
                'Earth North': 'EART Library',
                'Earth South': 'EART Library',
                'ENGI': 'ENGI Library',
                'ENVI': 'ENVI Library',
                'GRAD': 'GRDS Library',
                'Math 2.9': 'MATH Library',
                'Moffit Entry': 'MOFF Library',
                'Moffitt Exit': 'MOFF Library',
                'Moffitt 4th': 'MOFF Library',
                'Morrison': 'MORR Library',
                'MUSI': 'MUSI',
                'News': 'NEWS Library',
                'OPTO': 'OPTO Library',
                'PHYS': 'PHYS Library',
                'SEAL': 'SEAL Library',
                'SOCR': 'SOCR Library'
            };
            
            // Download the data
            myConnector.getData = function(table, doneCallback) {
                // Hardcoded credentials for testing
                var client_id = 'd301bb92-9de7-43bb-b5fd-da0468122f78';
                var client_secret = 'dff55e62-da91-4417-bad5-8d8cbb1ccc7d';
                
                var start_date = tableau.connectionData.start_date;
                var end_date = tableau.connectionData.end_date;
                
                console.log("Authenticating with:", {
                    client_id: client_id,
                    client_secret: client_secret,
                    start_date: start_date,
                    end_date: end_date
                });
                
                // First get the access token
                $.ajax({
                    url: "https://auth.sensourceinc.com/oauth/token",
                    type: "POST",
                    contentType: "application/json", // Match Python script
                    data: JSON.stringify({
                        grant_type: "client_credentials",
                        client_id: client_id,
                        client_secret: client_secret
                    }),
                    success: function(authResponse) {
                        console.log("Authentication successful:", authResponse);
                        var access_token = authResponse.access_token;
                        
                        // Then get the traffic data
                        $.ajax({
                            url: "https://vea.sensourceinc.com/api/data/traffic",
                            type: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": "Bearer " + access_token
                            },
                            data: {
                                relativeDate: "custom",
                                startDate: start_date,
                                endDate: end_date,
                                dateGroupings: "hour",
                                entityType: "zone"
                            },
                            success: function(resp) {
                                console.log("Data retrieval successful:", resp);
                                var results = resp.results;
                                var tableData = [];
                                
                                // Process each row of data
                                for (var i = 0; i < results.length; i++) {
                                    var item = results[i];
                                    var entranceName = item.name;
                                    var facility = facilityMapping[entranceName] || 'Unmapped';
                                    
                                    // Parse date 
                                    var dateTimeStr = item.recordDate_hour_1;
                                    var dateTime = new Date(dateTimeStr);
                                    
                                    tableData.push({
                                        dateTime: dateTime,
                                        entrance: entranceName,
                                        facility: facility,
                                        entries: parseInt(item.sumins) || 0,
                                        exits: parseInt(item.sumouts) || 0
                                    });
                                }
                                
                                table.appendRows(tableData);
                                doneCallback();
                            },
                            error: function(xhr, status, error) {
                                console.error("Error fetching traffic data:", error, xhr.responseText);
                                tableau.abortWithError("Error fetching traffic data: " + error + " - " + xhr.responseText);
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Authentication failed:", error, xhr.responseText);
                        tableau.abortWithError("Authentication failed: " + error + " - " + xhr.responseText);
                    }
                });
            };

            // Register the connector
            tableau.registerConnector(myConnector);
            
            // Setup the click handler for the button
            $(document).ready(function() {
                $("#submitButton").click(function() {
                    var start_date = $('#start_date').val().trim();
                    var end_date = $('#end_date').val().trim();
                    
                    // Validate inputs
                    function isValidDate(dateStr) {
                        var d = new Date(dateStr);
                        return !isNaN(d.getTime());
                    }
                    
                    if (!isValidDate(start_date) || !isValidDate(end_date)) {
                        $('#errorMsg').html("Enter valid dates. Format: YYYY-MM-DD");
                        return;
                    }
                    
                    // Convert dates to ISO format with time for API
                    var startDateObj = new Date(start_date);
                    var endDateObj = new Date(end_date);
                    var startISOString = startDateObj.toISOString();
                    var endISOString = endDateObj.toISOString();
                    
                    // Store dates in connectionData
                    tableau.connectionData = JSON.stringify({
                        start_date: startISOString,
                        end_date: endISOString
                    });
                    
                    tableau.connectionName = "Library Traffic Data";
                    tableau.submit();
                });
            });
        })();
    </script>
</body>
</html>
