<!DOCTYPE html>
<html>
<head>
    <title>Library Traffic Data Connector</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Import the Tableau WDC library -->
    <script src="https://connectors.tableau.com/libs/tableauwdc-3.0.latest.js" type="text/javascript"></script>
    
    <!-- Simple styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #errorMsg {
            color: red;
            margin-bottom: 10px;
        }
        .loading {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>Library Traffic Data Connector</h1>
    <div id="errorMsg"></div>
    
    <div class="form-group">
        <label for="client_id">Client ID:</label>
        <input type="text" id="client_id">
    </div>
    
    <div class="form-group">
        <label for="client_secret">Client Secret:</label>
        <input type="password" id="client_secret">
    </div>
    
    <div class="form-group">
        <label for="start_date">Start Date (YYYY-MM-DD):</label>
        <input type="date" id="start_date">
    </div>
    
    <div class="form-group">
        <label for="end_date">End Date (YYYY-MM-DD):</label>
        <input type="date" id="end_date">
    </div>
    
    <button type="button" id="submitButton">Get Data</button>
    <div class="loading" id="loadingIndicator">Loading...</div>

    <script>
        (function() {
            // Create the connector object
            var myConnector = tableau.makeConnector();
            
            // Define the schema
            myConnector.getSchema = function(schemaCallback) {
                var cols = [{
                    id: "dateTime",
                    alias: "Date-Time",
                    dataType: tableau.dataTypeEnum.datetime
                }, {
                    id: "entrance",
                    alias: "Entrance",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "facility",
                    alias: "Facility",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "entries",
                    alias: "Entries",
                    dataType: tableau.dataTypeEnum.int
                }, {
                    id: "exits",
                    alias: "Exits",
                    dataType: tableau.dataTypeEnum.int
                }];

                var tableSchema = {
                    id: "libraryTraffic",
                    alias: "Library Traffic Data",
                    columns: cols
                };

                schemaCallback([tableSchema]);
            };

            // Download the data
            myConnector.getData = function(table, doneCallback) {
                var connData = JSON.parse(tableau.connectionData);
                var client_id = connData.client_id;
                var client_secret = connData.client_secret;
                var start_date = connData.start_date;
                var end_date = connData.end_date;

                // First get the access token
                $.ajax({
                    url: "https://auth.sensourceinc.com/oauth/token",
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        grant_type: "client_credentials",
                        client_id: client_id,
                        client_secret: client_secret
                    },
                    success: function(authResponse) {
                        var access_token = authResponse.access_token;
                        
                        // Then get the traffic data
                        $.ajax({
                            url: "https://vea.sensourceinc.com/api/data/traffic",
                            type: "GET",
                            headers: {
                                "Authorization": "Bearer " + access_token
                            },
                            data: {
                                relativeDate: "custom",
                                startDate: start_date,
                                endDate: end_date,
                                dateGroupings: "hour",
                                entityType: "zone"
                            },
                            success: function(resp) {
                                var results = resp.results || [];
                                var tableData = [];
                                
                                // Process each row of data
                                for (var i = 0; i < results.length; i++) {
                                    var item = results[i];
                                    var entranceName = item.name;
                                    
                                    // Simple facility mapping (you may need to expand this)
                                    var facility = entranceName.split(' ')[0] || 'Unmapped';
                                    
                                    // Parse date
                                    var dateTimeStr = item.recordDate_hour_1;
                                    var dateTime = new Date(dateTimeStr);
                                    
                                    // Only add valid records
                                    if (!isNaN(dateTime.getTime())) {
                                        tableData.push({
                                            "dateTime": dateTime,
                                            "entrance": entranceName,
                                            "facility": facility,
                                            "entries": parseInt(item.sumins) || 0,
                                            "exits": parseInt(item.sumouts) || 0
                                        });
                                    }
                                }
                                
                                // Append data
                                table.appendRows(tableData);
                                doneCallback();
                            },
                            error: function(xhr, status, error) {
                                tableau.abortWithError("Error fetching traffic data: " + error);
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        tableau.abortWithError("Authentication failed: " + error);
                    }
                });
            };

            // Register the connector
            tableau.registerConnector(myConnector);
            
            // Setup the click handler for the button
            $(document).ready(function() {
                // Set default dates
                var today = new Date();
                var yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                $('#end_date').val(formatDate(today));
                $('#start_date').val(formatDate(yesterday));
                
                function formatDate(date) {
                    var year = date.getFullYear();
                    var month = (date.getMonth() + 1).toString().padStart(2, '0');
                    var day = date.getDate().toString().padStart(2, '0');
                    return year + '-' + month + '-' + day;
                }
                
                $("#submitButton").click(function() {
                    var client_id = $('#client_id').val().trim();
                    var client_secret = $('#client_secret').val().trim();
                    var start_date = $('#start_date').val().trim();
                    var end_date = $('#end_date').val().trim();
                    
                    // Validate inputs
                    if (!client_id || !client_secret) {
                        $('#errorMsg').html("Please enter both Client ID and Client Secret");
                        return;
                    }
                    
                    if (!start_date || !end_date) {
                        $('#errorMsg').html("Please enter both Start Date and End Date");
                        return;
                    }
                    
                    // Show loading indicator
                    $('#loadingIndicator').show();
                    $('#errorMsg').html("");
                    
                    // Store the credentials in connectionData
                    var connectionData = {
                        "client_id": client_id,
                        "client_secret": client_secret,
                        "start_date": start_date,
                        "end_date": end_date
                    };
                    
                    tableau.connectionData = JSON.stringify(connectionData);
                    tableau.connectionName = "Library Traffic Data";
                    tableau.submit();
                });
            });
        })();
    </script>
</body>
</html>
