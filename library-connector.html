<!DOCTYPE html>
<html>
<head>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
</head>
<body>
    <script>
        const connector = tableau.makeConnector();
        
        const CLIENT_ID = "d301bb92-9de7-43bb-b5fd-da0468122f78";
        const CLIENT_SECRET = "dff55e62-da91-4417-bad5-8d8cbb1ccc7d";

        connector.getData = function(table) {
            // 1. Get token directly in browser (INSECURE)
            fetch("https://auth.sensourceinc.com/oauth/token", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    grant_type: "client_credentials",
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET
                })
            })
            .then(r => r.json())
            .then(token => {
                // 2. Fetch data directly
                fetch("https://vea.sensourceinc.com/api/data/traffic?start=2024-01-01&end=2024-01-02", {
                    headers: {"Authorization": "Bearer " + token.access_token}
                })
                .then(r => r.json())
                .then(data => {
                    table.appendRows(data.results.map(item => ({
                        datetime: new Date(item.recordDate_hour_1),
                        entrance: item.name,
                        entries: item.sumins
                    })));
                    tableau.submit();
                });
            });
        };

        tableau.registerConnector(connector);
        tableau.connectionName = "Insecure Demo";
        tableau.submit();
    </script>
</body>
</html>
