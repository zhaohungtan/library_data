<!DOCTYPE html>
<html>
<head>
    <title>Library Traffic Data Connector</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Import the Tableau WDC library -->
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script>
    
    <!-- Simple styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #errorMsg {
            color: red;
            margin-bottom: 10px;
        }
        .loading {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>Library Traffic Data Connector</h1>
    <div id="errorMsg"></div>
    
    <div class="form-group">
        <label for="client_id">Client ID:</label>
        <input type="text" id="client_id">
    </div>
    
    <div class="form-group">
        <label for="client_secret">Client Secret:</label>
        <input type="password" id="client_secret">
    </div>
    
    <div class="form-group">
        <label for="start_date">Start Date (YYYY-MM-DD):</label>
        <input type="date" id="start_date">
    </div>
    
    <div class="form-group">
        <label for="end_date">End Date (YYYY-MM-DD):</label>
        <input type="date" id="end_date">
    </div>
    
    <button type="button" id="submitButton">Get Data</button>
    <div class="loading" id="loadingIndicator">Loading...</div>

    <script>
        (function() {
            // Create the connector object
            var myConnector = tableau.makeConnector();
            
            // Define the schema
            myConnector.getSchema = function(schemaCallback) {
                var cols = [{
                    id: "dateTime",
                    alias: "Date-Time",
                    dataType: tableau.dataTypeEnum.datetime
                }, {
                    id: "entrance",
                    alias: "Entrance",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "facility",
                    alias: "Facility",
                    dataType: tableau.dataTypeEnum.string
                }, {
                    id: "entries",
                    alias: "Entries",
                    dataType: tableau.dataTypeEnum.int
                }, {
                    id: "exits",
                    alias: "Exits",
                    dataType: tableau.dataTypeEnum.int
                }];

                var tableSchema = {
                    id: "libraryTraffic",
                    alias: "Library Traffic Data",
                    columns: cols
                };

                schemaCallback([tableSchema]);
            };

            // Define the facility mapping
            var facilityMapping = {
                'AHC Back': 'AHC Library',
                'AHC Front': 'AHC Library',
                'AHC Rear': 'AHC Library',
                'ANTH': 'ANTH Library',
                'Bancroft': 'BANC Library',
                'CHEM': 'CHEM Library',
                'VLSB1': 'BIOS Library',
                'VLSB2': 'BIOS Library',
                'EAL': 'EAL Library',
                'CHEM 2.9': 'CHEM Library',
                'Doe North': 'DOE Library',
                'Doe South': 'DOE Library',
                'HAAS 2nd Floor': 'HAAS Library',
                'HAAS 3rd Floor': 'HAAS Library',
                'MATH': 'MATH Library',
                'Moffit Corridor': 'DOE STACKS',
                'Stacks East': 'DOE STACKS',
                'EAL 2.9': 'EAL Library',
                'Earth North': 'EART Library',
                'Earth South': 'EART Library',
                'ENGI': 'ENGI Library',
                'ENVI': 'ENVI Library',
                'GRAD': 'GRDS Library',
                'Math 2.9': 'MATH Library',
                'Moffit Entry': 'MOFF Library',
                'Moffitt Exit': 'MOFF Library',
                'Moffitt 4th': 'MOFF Library',
                'Morrison': 'MORR Library',
                'MUSI': 'MUSI',
                'News': 'NEWS Library',
                'OPTO': 'OPTO Library',
                'PHYS': 'PHYS Library',
                'SEAL': 'SEAL Library',
                'SOCR': 'SOCR Library'
            };
            
            // Add initialization function
            myConnector.init = function(initCallback) {
                tableau.authType = tableau.authTypeEnum.custom;
                
                // If we have auth credentials in the data, we're in the data gathering phase
                if (tableau.phase == tableau.phaseEnum.gatherDataPhase) {
                    // If connectionData exists, use it
                    if (tableau.connectionData) {
                        try {
                            // Try parsing the connection data
                            JSON.parse(tableau.connectionData);
                        } catch (e) {
                            // If parsing fails, abort
                            tableau.abortWithError("Invalid connection data");
                            return;
                        }
                    }
                }
                
                initCallback();
            };
            
            // Download the data
            myConnector.getData = function(table, doneCallback) {
                // Show loading indicator if we're in Tableau
                if (typeof tableau !== 'undefined' && tableau.phase === tableau.phaseEnum.gatherDataPhase) {
                    tableau.reportProgress("Getting authentication token...");
                }
                
                // Get the connection data
                var connData = JSON.parse(tableau.connectionData);
                var client_id = connData.client_id;
                var client_secret = connData.client_secret;
                var start_date = connData.start_date;
                var end_date = connData.end_date;
                
                // Debug
                console.log("Connection data:", {
                    client_id: client_id,
                    start_date: start_date,
                    end_date: end_date
                });
                
                // First get the access token
                $.ajax({
                    url: "https://auth.sensourceinc.com/oauth/token",
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        grant_type: "client_credentials",
                        client_id: client_id,
                        client_secret: client_secret
                    },
                    success: function(authResponse) {
                        var access_token = authResponse.access_token;
                        
                        // Report progress
                        if (typeof tableau !== 'undefined') {
                            tableau.reportProgress("Authentication successful. Fetching traffic data...");
                        }
                        
                        console.log("Got access token");
                        
                        // Then get the traffic data
                        $.ajax({
                            url: "https://vea.sensourceinc.com/api/data/traffic",
                            type: "GET",
                            headers: {
                                "Authorization": "Bearer " + access_token
                            },
                            data: {
                                relativeDate: "custom",
                                startDate: start_date,
                                endDate: end_date,
                                dateGroupings: "hour",
                                entityType: "zone"
                            },
                            success: function(resp) {
                                console.log("API Response:", resp);
                                
                                // Report progress
                                if (typeof tableau !== 'undefined') {
                                    tableau.reportProgress("Processing data...");
                                }
                                
                                var results = resp.results || [];
                                var tableData = [];
                                
                                // Process each row of data
                                for (var i = 0; i < results.length; i++) {
                                    var item = results[i];
                                    var entranceName = item.name;
                                    var facility = facilityMapping[entranceName] || 'Unmapped';
                                    
                                    // Parse date - ensure proper handling of date
                                    var dateTimeStr = item.recordDate_hour_1;
                                    var dateTime;
                                    
                                    try {
                                        dateTime = new Date(dateTimeStr);
                                        // Check if date is valid
                                        if (isNaN(dateTime.getTime())) {
                                            console.warn("Invalid date:", dateTimeStr);
                                            dateTime = null;
                                        }
                                    } catch (e) {
                                        console.error("Date parsing error:", e);
                                        dateTime = null;
                                    }
                                    
                                    // Only add valid records
                                    if (dateTime) {
                                        tableData.push({
                                            "dateTime": dateTime,
                                            "entrance": entranceName,
                                            "facility": facility,
                                            "entries": parseInt(item.sumins) || 0,
                                            "exits": parseInt(item.sumouts) || 0
                                        });
                                    }
                                    
                                    // Report progress periodically
                                    if (i % 100 === 0 && typeof tableau !== 'undefined') {
                                        tableau.reportProgress("Processed " + i + " of " + results.length + " records");
                                    }
                                }
                                
                                console.log("Processed " + tableData.length + " records");
                                
                                // Append data in chunks to avoid memory issues
                                var chunkSize = 1000;
                                for (var i = 0; i < tableData.length; i += chunkSize) {
                                    table.appendRows(tableData.slice(i, i + chunkSize));
                                    
                                    // Report progress
                                    if (typeof tableau !== 'undefined') {
                                        tableau.reportProgress("Appended " + Math.min(i + chunkSize, tableData.length) + " of " + tableData.length + " records");
                                    }
                                }
                                
                                doneCallback();
                            },
                            error: function(xhr, status, error) {
                                console.error("Error fetching traffic data:", error);
                                console.error("Status:", status);
                                console.error("Response:", xhr.responseText);
                                tableau.abortWithError("Error fetching traffic data: " + error);
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Authentication failed:", error);
                        console.error("Status:", status);
                        console.error("Response:", xhr.responseText);
                        tableau.abortWithError("Authentication failed: " + error);
                    }
                });
            };

            // Register the connector
            tableau.registerConnector(myConnector);
            
            // Setup the click handler for the button
            $(document).ready(function() {
                // Set today's date as default for end date
                var today = new Date();
                var yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                $('#end_date').val(formatDate(today));
                $('#start_date').val(formatDate(yesterday));
                
                function formatDate(date) {
                    var year = date.getFullYear();
                    var month = (date.getMonth() + 1).toString().padStart(2, '0');
                    var day = date.getDate().toString().padStart(2, '0');
                    return year + '-' + month + '-' + day;
                }
                
                $("#submitButton").click(function() {
                    var client_id = $('#client_id').val().trim();
                    var client_secret = $('#client_secret').val().trim();
                    var start_date = $('#start_date').val().trim();
                    var end_date = $('#end_date').val().trim();
                    
                    // Validate inputs
                    if (!client_id || !client_secret) {
                        $('#errorMsg').html("Please enter both Client ID and Client Secret");
                        return;
                    }
                    
                    if (!start_date || !end_date) {
                        $('#errorMsg').html("Please enter both Start Date and End Date");
                        return;
                    }
                    
                    // Format dates properly for the API
                    try {
                        var startDateObj = new Date(start_date);
                        var endDateObj = new Date(end_date);
                        
                        // Check if dates are valid
                        if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
                            $('#errorMsg').html("Please enter valid dates");
                            return;
                        }
                        
                        // Add time to end date to include the entire day
                        endDateObj.setHours(23, 59, 59, 999);
                        
                        // Format dates for API
                        var startISOString = startDateObj.toISOString();
                        var endISOString = endDateObj.toISOString();
                    } catch (e) {
                        $('#errorMsg').html("Date error: " + e.message);
                        return;
                    }
                    
                    // Show loading indicator
                    $('#loadingIndicator').show();
                    $('#errorMsg').html("");
                    
                    // Store the credentials in connectionData
                    var connectionData = {
                        "client_id": client_id,
                        "client_secret": client_secret,
                        "start_date": startISOString,
                        "end_date": endISOString
                    };
                    
                    tableau.connectionData = JSON.stringify(connectionData);
                    tableau.connectionName = "Library Traffic Data";
                    tableau.submit();
                });
            });
        })();
    </script>
</body>
</html>
